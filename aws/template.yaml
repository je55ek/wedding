AWSTemplateFormatVersion : '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Flying Js serverless wedding RSVP application.

Parameters:
  BucketName:
    Type: String
    Description: Name of the S3 bucket that contains the zipped wedding code.
    Default: flyingj-code-dev
  CodeKey:
    Type: String
    Description: S3 object key of the zipped wedding code.

Resources:
  Parties:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.parties_handler
      Runtime: python3.6
      Policies:
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Resource: !GetAtt
              - PartiesTable
              - Arn
            Action:
              - dynamodb:BatchGetItem
              - dynamodb:BatchWriteItem
              - dynamodb:PutItem
              - dynamodb:DeleteItem
              - dynamodb:Scan
              - dynamodb:Query
              - dynamodb:UpdateItem
              - dynamodb:CreateTable
              - dynamodb:DescribeTable
              - dynamodb:GetShardIterator
              - dynamodb:GetItem
              - dynamodb:UpdateTable
              - dynamodb:GetRecords
      CodeUri:
        Bucket: !Ref BucketName
        Key: !Ref CodeKey
      Environment:
        Variables:
          PARTIES_TABLE: !Ref PartiesTable
      Events:
        GetParties:
          Type: Api
          Properties:
            Path: /parties
            Method: get
        GetParty:
          Type: Api
          Properties:
            Path: /parties/{id}
            Method: get
        UpdateParty:
          Type: Api
          Properties:
            Path: /parties/{id}
            Method: post
        CreateParty:
          Type: Api
          Properties:
            Path: /parties
            Method: post
        DeleteParty:
          Type: Api
          Properties:
            Path: /parties/{id}
            Method: delete
  PartiesTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      PrimaryKey:
        Name: id
        Type: String
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
  Drivers:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.drivers_handler
      Runtime: python3.6
      Policies:
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Resource: !GetAtt
              - DriversTable
              - Arn
            Action:
              - dynamodb:BatchGetItem
              - dynamodb:BatchWriteItem
              - dynamodb:PutItem
              - dynamodb:DeleteItem
              - dynamodb:Scan
              - dynamodb:Query
              - dynamodb:UpdateItem
              - dynamodb:CreateTable
              - dynamodb:DescribeTable
              - dynamodb:GetShardIterator
              - dynamodb:GetItem
              - dynamodb:UpdateTable
              - dynamodb:GetRecords
      CodeUri:
        Bucket: !Ref BucketName
        Key: !Ref CodeKey
      Environment:
        Variables:
          DRIVERS_TABLE: !Ref DriversTable
      Events:
        GetDrivers:
          Type: Api
          Properties:
            Path: /drivers
            Method: get
        GetDriver:
          Type: Api
          Properties:
            Path: /drivers/{id}
            Method: get
        UpdateDriver:
          Type: Api
          Properties:
            Path: /drivers/{id}
            Method: post
        CreateDriver:
          Type: Api
          Properties:
            Path: /drivers
            Method: post
        DeleteDriver:
          Type: Api
          Properties:
            Path: /drivers/{id}
            Method: delete
  DriversTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      PrimaryKey:
        Name: id
        Type: String
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
  Passengers:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.passengers_handler
      Runtime: python3.6
      Policies:
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Resource: !GetAtt
              - PassengersTable
              - Arn
            Action:
              - dynamodb:BatchGetItem
              - dynamodb:BatchWriteItem
              - dynamodb:PutItem
              - dynamodb:DeleteItem
              - dynamodb:Scan
              - dynamodb:Query
              - dynamodb:UpdateItem
              - dynamodb:CreateTable
              - dynamodb:DescribeTable
              - dynamodb:GetShardIterator
              - dynamodb:GetItem
              - dynamodb:UpdateTable
              - dynamodb:GetRecords
      CodeUri:
        Bucket: !Ref BucketName
        Key: !Ref CodeKey
      Environment:
        Variables:
          PASSENGERS_TABLE: !Ref PassengersTable
      Events:
        GetPassengers:
          Type: Api
          Properties:
            Path: /passengers
            Method: get
        GetPassenger:
          Type: Api
          Properties:
            Path: /passengers/{id}
            Method: get
        UpdatePassenger:
          Type: Api
          Properties:
            Path: /passengers/{id}
            Method: post
        CreatePassengers:
          Type: Api
          Properties:
            Path: /passengers
            Method: post
        DeletePassenger:
          Type: Api
          Properties:
            Path: /passengers/{id}
            Method: delete
  PassengersTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      PrimaryKey:
        Name: id
        Type: String
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
